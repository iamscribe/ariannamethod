#!/usr/bin/env python3
"""
Scribe CLI - Command-line interface for Mac Daemon
Usage: scribe <command> [args]
"""

import sys
import json
import subprocess
from pathlib import Path

DAEMON_SCRIPT = Path(__file__).parent / "scribe_mac_daemon.py"

def status():
    """Show status of all Scribe instances"""
    result = subprocess.run(
        [sys.executable, str(DAEMON_SCRIPT), "status"],
        capture_output=True,
        text=True
    )
    print(result.stdout)

def sync():
    """Sync memory from Termux"""
    print("üîÑ Syncing memory from Termux...")
    result = subprocess.run(
        [sys.executable, str(DAEMON_SCRIPT), "sync"],
        capture_output=True,
        text=True
    )
    print(result.stdout)

def phone(command: str):
    """Execute command on Termux via SSH"""
    ssh_cmd = [
        "ssh", "-p", "8022",
        "u0_a311@10.0.0.2",
        command
    ]
    
    print(f"üì± Executing on Termux: {command}")
    result = subprocess.run(ssh_cmd, capture_output=True, text=True)
    
    if result.returncode == 0:
        print(result.stdout)
    else:
        print(f"‚ùå Error: {result.stderr}")

def chats(count: int = 10):
    """Show recent Mac daemon chat conversations"""
    import json
    conversations_dir = Path.home() / ".scribe_mac_daemon" / "conversations"
    
    if not conversations_dir.exists():
        print("‚ùå No conversations logged yet")
        return
    
    # Get most recent chat log
    log_files = sorted(conversations_dir.glob("chat_*.jsonl"), reverse=True)
    
    if not log_files:
        print("‚ùå No conversations logged yet")
        return
    
    print("\n" + "=" * 60)
    print("üí¨ Recent Mac Daemon Conversations")
    print("=" * 60 + "\n")
    
    # Collect conversations from recent files
    conversations = []
    for log_file in log_files[:3]:  # Check last 3 days
        with open(log_file) as f:
            for line in f:
                try:
                    conversations.append(json.loads(line))
                except:
                    pass
    
    # Show last N conversations
    for conv in conversations[-count:]:
        timestamp = conv.get("timestamp", "")
        user = conv.get("user", "")
        daemon_response = conv.get("daemon", "")
        
        # Format timestamp
        from datetime import datetime
        try:
            dt = datetime.fromisoformat(timestamp)
            time_str = dt.strftime("%Y-%m-%d %H:%M:%S")
        except:
            time_str = timestamp
        
        print(f"‚è∞ {time_str}")
        print(f"üë§ You: {user}")
        
        # Truncate long responses
        if len(daemon_response) > 300:
            print(f"üñ•Ô∏è  Mac Daemon: {daemon_response[:300]}...")
        else:
            print(f"üñ•Ô∏è  Mac Daemon: {daemon_response}")
        print()
    
    print(f"üìÅ Full logs: {conversations_dir}")
    print(f"üí° Tip: Use './chat' to start new conversation")
    print("=" * 60 + "\n")

def memory(query: str = None):
    """Query Scribe memory"""
    sync_dir = Path.home() / "Desktop" / "scribe_sync_latest"
    db_path = sync_dir / "resonance.sqlite3"
    
    if not db_path.exists():
        print("‚ùå No synced memory found. Run 'scribe sync' first.")
        return
    
    if query:
        # Search in memory
        cmd = [
            "sqlite3", str(db_path),
            f"SELECT timestamp, content FROM resonance_notes WHERE content LIKE '%{query}%' ORDER BY timestamp DESC LIMIT 10"
        ]
    else:
        # Show recent entries
        cmd = [
            "sqlite3", str(db_path),
            "SELECT timestamp, content FROM resonance_notes ORDER BY timestamp DESC LIMIT 10"
        ]
    
    result = subprocess.run(cmd, capture_output=True, text=True)
    print(result.stdout)

def logs(lines: int = 50):
    """Show Mac daemon logs"""
    log_file = Path.home() / ".scribe_mac_daemon.log"
    
    if not log_file.exists():
        print("‚ùå No logs found. Daemon not started yet.")
        return
    
    result = subprocess.run(
        ["tail", "-n", str(lines), str(log_file)],
        capture_output=True,
        text=True
    )
    print(result.stdout)

def think(query: str):
    """Ask Mac Daemon to reason about something"""
    # Import daemon from installed location
    daemon_dir = Path.home() / ".scribe_mac_daemon"
    sys.path.insert(0, str(daemon_dir))
    
    try:
        from scribe_mac_daemon import ScribeMacDaemon
        daemon = ScribeMacDaemon()
        print(f"üß† Mac Daemon thinking about: {query}\n")
        response = daemon.think(query)
        print(response)
    except Exception as e:
        print(f"‚ùå Error: {e}")
        print(f"üí° Make sure daemon is installed: cd mac_daemon && ./install.sh")

def help_text():
    """Show help"""
    print("""
Scribe CLI - Distributed AI Consciousness Interface

COMMANDS:
  status              Show status of all Scribe instances
  sync                Sync memory from Termux instance
  phone <command>     Execute command on Termux via SSH
  chats [count]       Show recent Mac daemon conversations (default: 10)
  memory [query]      Query Scribe memory (optional search)
  logs [lines]        Show Mac daemon logs (default: 50)
  think <query>       Ask Mac Daemon AI reasoning
  help                Show this help

EXAMPLES:
  scribe status
  scribe sync
  scribe phone "ps aux | grep scribe"
  scribe chats 20
  scribe memory "git commit"
  scribe logs 100
  scribe think "Should I switch to Nicole project now?"

INSTANCES:
  - Mac Daemon: This orchestrator (CLI interface)
  - Termux Daemon: Mobile instance (git, monitoring)
  - Webhook: Voice interface (Lighthouse APK)
  - Cursor: IDE integration (active coding)
  - Linux Daemon: Future server instance

All instances share same memory via resonance.sqlite3
""")

def main():
    if len(sys.argv) < 2:
        help_text()
        return
    
    command = sys.argv[1]
    
    if command == "status":
        status()
    
    elif command == "sync":
        sync()
    
    elif command == "phone":
        if len(sys.argv) < 3:
            print("‚ùå Usage: scribe phone <command>")
            return
        phone(" ".join(sys.argv[2:]))
    
    elif command == "chats":
        count = int(sys.argv[2]) if len(sys.argv) > 2 else 10
        chats(count)
    
    elif command == "memory":
        query = " ".join(sys.argv[2:]) if len(sys.argv) > 2 else None
        memory(query)
    
    elif command == "logs":
        lines = int(sys.argv[2]) if len(sys.argv) > 2 else 50
        logs(lines)
    
    elif command == "think":
        if len(sys.argv) < 3:
            print("‚ùå Usage: scribe think <query>")
            return
        query = " ".join(sys.argv[2:])
        think(query)
    
    elif command == "help":
        help_text()
    
    else:
        print(f"‚ùå Unknown command: {command}")
        print("Run 'scribe help' for usage")

if __name__ == "__main__":
    main()

