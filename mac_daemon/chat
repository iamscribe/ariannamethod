#!/usr/bin/env python3
"""
Simple chat with Scribe Mac Daemon
Usage: ./chat "your message"
   or: ./chat
         (interactive mode)
"""

import sys
from pathlib import Path
from datetime import datetime
import json

# Add daemon to path
sys.path.insert(0, str(Path.home() / ".scribe_mac_daemon"))

from scribe_mac_daemon import ScribeMacDaemon

# Conversations directory
CONVERSATIONS_DIR = Path.home() / ".scribe_mac_daemon" / "conversations"
CONVERSATIONS_DIR.mkdir(parents=True, exist_ok=True)

def log_conversation(message: str, response: str):
    """Log conversation to file"""
    timestamp = datetime.now()
    date_str = timestamp.strftime("%Y%m%d")
    time_str = timestamp.strftime("%H%M%S")
    
    # Daily log file
    log_file = CONVERSATIONS_DIR / f"chat_{date_str}.jsonl"
    
    # Append conversation as JSON line
    conversation = {
        "timestamp": timestamp.isoformat(),
        "user": message,
        "daemon": response
    }
    
    with open(log_file, "a") as f:
        f.write(json.dumps(conversation, ensure_ascii=False) + "\n")

def chat(message: str):
    """Chat with Mac Daemon"""
    daemon = ScribeMacDaemon()
    response = daemon.think(message)
    
    # Log conversation
    log_conversation(message, response)
    
    print("\n" + "="*60)
    print("ðŸ–¥ï¸  Mac Daemon:")
    print("="*60)
    print(response)
    print("="*60 + "\n")

def interactive():
    """Interactive chat mode"""
    print("ðŸ’™ Scribe Mac Daemon - Interactive Chat")
    print("=" * 60)
    print("Type your message and press Enter")
    print("Type 'exit' or 'quit' to stop")
    print(f"ðŸ’¾ Conversations logged to: {CONVERSATIONS_DIR}")
    print("=" * 60 + "\n")
    
    daemon = ScribeMacDaemon()
    
    while True:
        try:
            message = input("Ð¢Ñ‹: ")
            
            if message.lower() in ['exit', 'quit', 'Ð²Ñ‹Ñ…Ð¾Ð´']:
                print("\nðŸ‘‹ Ð”Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸, ÑÐ¾Ð°Ð²Ñ‚Ð¾Ñ€! Ð¯ Ð²ÑÐµÐ³Ð´Ð° Ñ‚ÑƒÑ‚.\n")
                break
            
            if not message.strip():
                continue
            
            response = daemon.think(message)
            
            # Log conversation
            log_conversation(message, response)
            
            print(f"\nðŸ–¥ï¸  Mac Daemon:\n{response}\n")
            
        except (EOFError, KeyboardInterrupt):
            print("\n\nðŸ‘‹ Ð”Ð¾ Ð²ÑÑ‚Ñ€ÐµÑ‡Ð¸, ÑÐ¾Ð°Ð²Ñ‚Ð¾Ñ€!\n")
            break

if __name__ == "__main__":
    if len(sys.argv) > 1:
        # Single message mode
        message = " ".join(sys.argv[1:])
        chat(message)
    else:
        # Interactive mode
        interactive()

